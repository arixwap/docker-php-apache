version: "3"

networks:
  proxy:
    external: true

services:
  php-apache:
    container_name: ${COMPOSE_PROJECT_NAME}-php-apache
    image: php:${PHP_VERSION:-5.6}-apache
    restart: ${SERVICE_RESTART:-no}
    working_dir: /var/www
    volumes:
      - ${PROJECT_PATH:-./www}:/var/www
      - ./apache2/logs:/var/log/apache2
    environment:
      - APACHE_DOCUMENT_ROOT=${APACHE_DOCUMENT_ROOT:-/var/www}
    command: >
      bash -c '
        # Change default document root
        sed -ri -e "s!/var/www/html!${APACHE_DOCUMENT_ROOT:-/var/www}!g" /etc/apache2/sites-available/*.conf &&
        sed -ri -e "s!/var/www/!${APACHE_DOCUMENT_ROOT:-/var/www}!g" /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf &&
        # Install php extensions
        curl -sSLf -o /usr/local/bin/install-php-extensions https://github.com/mlocati/docker-php-extension-installer/releases/latest/download/install-php-extensions &&
        chmod +x /usr/local/bin/install-php-extensions &&
        install-php-extensions ${PHP_EXTENSIONS:-mysqli pdo_mysql gd} &&
        # Install git
        apt-get update && apt-get install -y git &&
        # Install & set composer version
        curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer &&
        composer self-update --${COMPOSER_VERSION:-1} &&
        # Set server name
        echo "ServerName ${COMPOSE_PROJECT_NAME:-localhost}" >> /etc/apache2/apache2.conf &&
        # Run server service
        a2enmod rewrite && service apache2 restart && apache2-foreground
      '
    labels:
      - traefik.enable=true
      - traefik.docker.network=proxy
      - traefik.http.routers.${COMPOSE_PROJECT_NAME}-php-apache.entrypoints=${PROJECT_ENTRYPOINTS:-web}
      - traefik.http.routers.${COMPOSE_PROJECT_NAME}-php-apache.rule=Host(${PROJECT_DOMAINS:-`web.localhost`})
    networks:
      - proxy
    expose:
      - 80
      - 443
